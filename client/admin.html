<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f4; color: #333; }
        .container { max-width: 800px; margin: auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 20px;}
        .hidden { display: none; }
        h1, h2, h3 { color: #555; }
        input, button { padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd; }
        button { background-color: #007bff; color: white; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; cursor: pointer; }
        th:hover { background-color: #e8e8e8; }
    </style>
</head>
<body>

<div id="login-section" class="container">
    <h1>Admin Login</h1>
    <form id="login-form">
        <input type="password" id="admin-password" placeholder="Enter Admin Password" required>
        <button type="submit">Login</button>
    </form>
    <p id="login-error" style="color: red;"></p>
</div>

<div id="admin-panel" class="container hidden">
    <h1>Admin Panel</h1>
    <p id="admin-message" style="color: green;"></p>

    <!-- User Management Section -->
    <section id="user-management">
        <h2>User Management</h2>

        <form id="create-user-form">
            <h3>Create User</h3>
            <input type="text" id="create-username" placeholder="Username" required>
            <input type="number" id="create-balance" placeholder="Initial Balance" step="any" required>
            <button type="submit">Create User</button>
        </form>

        <hr>

        <h3>All Users</h3>
        <input type="text" id="user-search" placeholder="Search by username or ID...">
        <table id="user-table">
            <thead>
                <tr>
                    <th data-sort="id">User ID</th>
                    <th data-sort="username">Username</th>
                    <th data-sort="balance">Balance</th>
                    <th>Update Balance</th>
                </tr>
            </thead>
            <tbody id="user-table-body">
                <!-- User rows will be inserted here by JavaScript -->
            </tbody>
        </table>
    </section>

    <hr>

    <!-- Payout Management Section -->
    <section id="payout-management">
        <h2>Payout Management</h2>
        <form id="payout-form">
            <h3>Edit Paytable</h3>
            <p>Edit payout multipliers below. Payout = Multiplier * Bet Amount.</p>
            <div id="paytable-container"></div>
            <button type="submit">Save Payouts</button>
        </form>
    </section>
</div>

<script>
    const loginSection = document.getElementById('login-section');
    const adminPanel = document.getElementById('admin-panel');
    const loginError = document.getElementById('login-error');
    const adminMessage = document.getElementById('admin-message');

    let adminToken = null;
    let allUsers = [];
    let sortState = { key: 'id', asc: true };

    // --- LOGIN ---
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        loginError.textContent = '';
        const password = document.getElementById('admin-password').value;

        try {
            const response = await fetch('/api/admin/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            const data = await response.json();
            if (response.ok) {
                adminToken = data.token;
                loginSection.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                await loadPaytable();
                await loadUsers();
            } else {
                throw new Error(data.message || 'Login failed');
            }
        } catch (err) {
            loginError.textContent = err.message;
        }
    });

    // --- API HELPER ---
    async function apiRequest(endpoint, method = 'GET', body = null) {
        const options = {
            method,
            headers: { 'Content-Type': 'application/json', 'x-admin-token': adminToken }
        };
        if (body) options.body = JSON.stringify(body);
        const response = await fetch(endpoint, options);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `API request to ${endpoint} failed`);
        }
        return response.json();
    }

    // --- USER MANAGEMENT (NEW) ---
    async function loadUsers() {
        try {
            allUsers = await apiRequest('/api/admin/users');
            renderUserTable(allUsers);
        } catch (err) {
            setMessage(`Error loading users: ${err.message}`, true);
        }
    }

    function renderUserTable(users) {
        const tbody = document.getElementById('user-table-body');
        tbody.innerHTML = ''; // Clear existing rows
        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.balance}</td>
                <td>
                    <input type="number" step="any" placeholder="New Balance" id="balance-input-${user.id}">
                    <button data-userid="${user.id}">Update</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    document.getElementById('user-table').addEventListener('click', (e) => {
        // Update button handler
        if (e.target.tagName === 'BUTTON' && e.target.dataset.userid) {
            const userId = e.target.dataset.userid;
            const newBalanceInput = document.getElementById(`balance-input-${userId}`);
            const newBalance = parseFloat(newBalanceInput.value);
            if (!isNaN(newBalance)) {
                updateUserBalance(userId, newBalance);
            } else {
                setMessage('Please enter a valid number for the balance.', true);
            }
        }
        // Sorting handler
        if (e.target.tagName === 'TH' && e.target.dataset.sort) {
            const sortKey = e.target.dataset.sort;
            sortState.asc = sortState.key === sortKey ? !sortState.asc : true;
            sortState.key = sortKey;
            sortUsers(sortKey, sortState.asc);
        }
    });

    function sortUsers(key, asc = true) {
        const sortedUsers = [...allUsers].sort((a, b) => {
            if (a[key] < b[key]) return asc ? -1 : 1;
            if (a[key] > b[key]) return asc ? 1 : -1;
            return 0;
        });
        renderUserTable(sortedUsers);
    }

    document.getElementById('user-search').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredUsers = allUsers.filter(user =>
            user.username.toLowerCase().includes(searchTerm) ||
            user.id.toLowerCase().includes(searchTerm)
        );
        renderUserTable(filteredUsers);
    });

    async function updateUserBalance(userId, newBalance) {
        try {
            const updatedUser = await apiRequest(`/api/admin/users/${userId}/balance`, 'PUT', { newBalance });
            setMessage(`User ${updatedUser.username}'s balance updated to ${updatedUser.balance}.`, false);
            await loadUsers(); // Refresh the user list
        } catch (err) {
            setMessage(`Error updating balance: ${err.message}`, true);
        }
    }

    // --- PAYOUT MANAGEMENT ---
    async function loadPaytable() { /* ... (omitted for brevity, no changes here) ... */ }
    document.getElementById('payout-form').addEventListener('submit', async (e) => { /* ... (omitted for brevity, no changes here) ... */ });

    // --- CREATE USER ---
    document.getElementById('create-user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('create-username').value;
        const initialBalance = parseFloat(document.getElementById('create-balance').value);
        try {
            const newUser = await apiRequest('/api/admin/users/create', 'POST', { username, initialBalance });
            setMessage(`User ${newUser.username} created successfully.`, false);
            e.target.reset();
            await loadUsers(); // Refresh the user list
        } catch (err) {
            setMessage(`Error creating user: ${err.message}`, true);
        }
    });

    function setMessage(msg, isError = false) {
        adminMessage.textContent = msg;
        adminMessage.style.color = isError ? 'red' : 'green';
    }

    // --- Re-pasting omitted functions for completeness ---
    async function loadPaytable() {
        try {
            const data = await apiRequest('/api/admin/settings');
            const container = document.getElementById('paytable-container');
            let tableHTML = '<table><thead><tr><th>Symbol</th><th>3 in a row</th><th>4 in a row</th><th>5 in a row</th></tr></thead><tbody>';
            for (const symbol in data.paytable) {
                const payouts = data.paytable[symbol];
                tableHTML += `<tr>
                    <td>${symbol}</td>
                    <td><input type="number" data-symbol="${symbol}" data-count="3" value="${payouts['3'] || 0}"></td>
                    <td><input type="number" data-symbol="${symbol}" data-count="4" value="${payouts['4'] || 0}"></td>
                    <td><input type="number" data-symbol="${symbol}" data-count="5" value="${payouts['5'] || 0}"></td>
                </tr>`;
            }
            tableHTML += '</tbody></table>';
            container.innerHTML = tableHTML;
        } catch (err) {
            setMessage(`Error loading paytable: ${err.message}`, true);
        }
    }

    document.getElementById('payout-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPaytable = {};
        const inputs = document.querySelectorAll('#paytable-container input');
        inputs.forEach(input => {
            const symbol = input.dataset.symbol;
            const count = input.dataset.count;
            if (!newPaytable[symbol]) newPaytable[symbol] = {};
            newPaytable[symbol][count] = parseInt(input.value, 10);
        });
        try {
            await apiRequest('/api/admin/settings', 'PUT', { paytable: newPaytable });
            setMessage('Payouts saved successfully! Note: This is saved in memory and will reset on server restart.', false);
        } catch (err) {
            setMessage(`Error saving paytable: ${err.message}`, true);
        }
    });

</script>

</body>
</html>
