<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
    <style>
        /* ... styles omitted for brevity ... */
        .form-grid-editors { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    </style>
</head>
<body>
<div id="login-section" class="container">...</div>
<div id="admin-panel" class="container hidden">
    <h1>Admin Panel <button id="logout-button">Logout</button></h1>
    <p id="admin-message"></p>
    <!-- User/Withdrawal/Stats sections ... -->
    <hr>
    <!-- Game Management Section -->
    <section id="game-management">
        <h2>Game Management</h2>
        <p>Select a game to edit its configuration.</p>
        <select id="game-select"></select>
        <form id="config-form" class="hidden">
            <h3 id="config-header"></h3>
            <div class="form-grid-editors">
                <div>
                    <h4>Paytable</h4>
                    <div id="paytable-container"></div>
                </div>
                <div>
                    <h4>Symbol Weights</h4>
                    <div id="symbol-weights-container"></div>
                </div>
            </div>
            <button type="submit">Save Configuration to Database</button>
            <div class="import-section">
                <h4>Import Configuration</h4>
                <textarea id="config-import-area" rows="8" placeholder="Paste configuration (paytable and/or symbolWeights) JSON here..."></textarea>
                <button type="button" id="import-config-btn">Load from JSON</button>
            </div>
        </form>
    </section>
    <hr>
</div>

<script>
    // --- Global Variables & Elements ---
    const gameSelect = document.getElementById('game-select');
    const adminMessage = document.getElementById('admin-message');
    let allGames = {}; // This will hold the basic game info (name, symbols)

    // --- Core Auth & API ---
    async function apiRequest(endpoint, method = 'GET', body = null) { /* ... same as before ... */ }

    // --- Initial Load ---
    async function loadInitialData() {
        try {
            // Only load the list of games initially
            const games = await apiRequest('/api/admin/games');
            gameSelect.innerHTML = '<option value="">-- Select a Game --</option>';
            games.forEach(game => {
                allGames[game.id] = game; // Store basic info
                const option = document.createElement('option');
                option.value = game.id;
                option.textContent = game.name;
                gameSelect.appendChild(option);
            });
        } catch (err) {
            setMessage(err.message, true);
        }
    }

    // --- Game Management ---
    gameSelect.addEventListener('change', async () => {
        const gameId = gameSelect.value;
        const configForm = document.getElementById('config-form');
        if (gameId) {
            try {
                // Fetch the full, detailed configuration for the selected game
                const config = await apiRequest(`/api/admin/game-config/${gameId}`);
                const baseInfo = allGames[gameId];

                document.getElementById('config-header').textContent = `Editing Configuration for: ${baseInfo.name}`;
                renderPaytableEditor(baseInfo.symbols, config.paytable);
                renderSymbolWeightsEditor(baseInfo.symbols, config.symbolWeights);
                configForm.classList.remove('hidden');
            } catch (err) {
                setMessage(err.message, true);
                configForm.classList.add('hidden');
            }
        } else {
            configForm.classList.add('hidden');
        }
    });

    function renderPaytableEditor(symbols, paytable) {
        // ... same as before, but targets new container
        const container = document.getElementById('paytable-container');
        // ... logic to build table
    }

    function renderSymbolWeightsEditor(symbols, weights) {
        const container = document.getElementById('symbol-weights-container');
        let tableHTML = '<table><thead><tr><th>Symbol</th><th>Weight</th></tr></thead><tbody>';
        for (const symbolKey in symbols) {
            tableHTML += `<tr>
                <td>${symbolKey}</td>
                <td><input type="number" class="symbol-weight-input" data-symbol="${symbolKey}" value="${weights[symbolKey] || 10}"></td>
            </tr>`;
        }
        tableHTML += '</tbody></table>';
        container.innerHTML = tableHTML;
    }

    document.getElementById('config-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const gameId = gameSelect.value;
        if (!gameId) return;

        // Collect data from BOTH editors
        const paytable = {};
        document.querySelectorAll('#paytable-container input').forEach(input => {
            const symbol = input.dataset.symbol;
            if (!paytable[symbol]) paytable[symbol] = {};
            paytable[symbol][input.dataset.count] = parseInt(input.value, 10) || 0;
        });

        const symbolWeights = {};
        document.querySelectorAll('#symbol-weights-container input').forEach(input => {
            symbolWeights[input.dataset.symbol] = parseInt(input.value, 10) || 0;
        });

        try {
            await apiRequest(`/api/admin/games/${gameId}`, 'PUT', { paytable, symbolWeights });
            setMessage(`Configuration for ${gameId} saved successfully.`, false);
        } catch (err) {
            setMessage(`Error saving configuration: ${err.message}`, true);
        }
    });

    document.getElementById('import-config-btn').addEventListener('click', () => {
        const jsonString = document.getElementById('config-import-area').value;
        try {
            const config = JSON.parse(jsonString);
            if (config.paytable) {
                document.querySelectorAll('#paytable-container input').forEach(input => {
                    const { symbol, count } = input.dataset;
                    if (config.paytable[symbol]?.[count] !== undefined) {
                        input.value = config.paytable[symbol][count];
                    }
                });
            }
            if (config.symbolWeights) {
                document.querySelectorAll('#symbol-weights-container input').forEach(input => {
                    const { symbol } = input.dataset;
                    if (config.symbolWeights[symbol] !== undefined) {
                        input.value = config.symbolWeights[symbol];
                    }
                });
            }
            setMessage('Configuration loaded into editor. Review and click "Save" to apply.', false);
        } catch (err) {
            setMessage('Invalid JSON in import area.', true);
        }
    });

    // --- Helper & Init ---
    function setMessage(msg, isError = false) { /* ... */ }
    window.addEventListener('load', loadInitialData);
    // Dummy login listener
    // Note: full script would include all other sections (user mgmt, etc.)
</script>
</body>
</html>
