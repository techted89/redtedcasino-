<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f4; color: #333; }
        .container { max-width: 800px; margin: auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); }
        .hidden { display: none; }
        h1, h2 { color: #555; }
        input, button { padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd; }
        button { background-color: #007bff; color: white; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        #payout-form table { width: 100%; border-collapse: collapse; }
        #payout-form th, #payout-form td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        #payout-form th { background-color: #f2f2f2; }
    </style>
</head>
<body>

<div id="login-section" class="container">
    <h1>Admin Login</h1>
    <form id="login-form">
        <input type="password" id="admin-password" placeholder="Enter Admin Password" required>
        <button type="submit">Login</button>
    </form>
    <p id="login-error" style="color: red;"></p>
</div>

<div id="admin-panel" class="container hidden">
    <h1>Admin Panel</h1>

    <!-- User Management Section -->
    <section id="user-management">
        <h2>User Management</h2>
        <form id="create-user-form">
            <h3>Create User</h3>
            <input type="text" id="create-username" placeholder="Username" required>
            <input type="number" id="create-balance" placeholder="Initial Balance" required>
            <button type="submit">Create User</button>
        </form>
        <hr>
        <form id="update-balance-form">
            <h3>Update User Balance</h3>
            <input type="text" id="update-userid" placeholder="User ID" required>
            <input type="number" id="update-balance" placeholder="New Balance" required>
            <button type="submit">Update Balance</button>
        </form>
    </section>

    <hr>

    <!-- Payout Management Section -->
    <section id="payout-management">
        <h2>Payout Management</h2>
        <form id="payout-form">
            <h3>Edit Paytable</h3>
            <p>Edit payout multipliers below. Payout = Multiplier * Bet Amount.</p>
            <div id="paytable-container"></div>
            <button type="submit">Save Payouts</button>
        </form>
    </section>
    <p id="admin-message" style="color: green;"></p>
</div>

<script>
    const loginSection = document.getElementById('login-section');
    const adminPanel = document.getElementById('admin-panel');
    const loginError = document.getElementById('login-error');
    const adminMessage = document.getElementById('admin-message');
    let adminToken = null;

    // --- LOGIN ---
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        loginError.textContent = '';
        const password = document.getElementById('admin-password').value;

        try {
            const response = await fetch('/api/admin/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            const data = await response.json();
            if (response.ok) {
                adminToken = data.token;
                loginSection.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                loadPaytable();
            } else {
                throw new Error(data.message || 'Login failed');
            }
        } catch (err) {
            loginError.textContent = err.message;
        }
    });

    // --- API HELPER ---
    async function apiRequest(endpoint, method = 'GET', body = null) {
        const options = {
            method,
            headers: {
                'Content-Type': 'application/json',
                'x-admin-token': adminToken
            }
        };
        if (body) {
            options.body = JSON.stringify(body);
        }
        const response = await fetch(endpoint, options);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `API request to ${endpoint} failed`);
        }
        return response.json();
    }

    // --- PAYOUT MANAGEMENT ---
    async function loadPaytable() {
        try {
            const data = await apiRequest('/api/admin/settings');
            const container = document.getElementById('paytable-container');
            let table = '<table><tr><th>Symbol</th><th>3 in a row</th><th>4 in a row</th><th>5 in a row</th></tr>';
            for (const symbol in data.paytable) {
                const payouts = data.paytable[symbol];
                table += `<tr>
                    <td>${symbol}</td>
                    <td><input type="number" data-symbol="${symbol}" data-count="3" value="${payouts['3'] || 0}"></td>
                    <td><input type="number" data-symbol="${symbol}" data-count="4" value="${payouts['4'] || 0}"></td>
                    <td><input type="number" data-symbol="${symbol}" data-count="5" value="${payouts['5'] || 0}"></td>
                </tr>`;
            }
            table += '</table>';
            container.innerHTML = table;
        } catch (err) {
            adminMessage.textContent = `Error loading paytable: ${err.message}`;
            adminMessage.style.color = 'red';
        }
    }

    document.getElementById('payout-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const newPaytable = {};
        const inputs = document.querySelectorAll('#paytable-container input');
        inputs.forEach(input => {
            const symbol = input.dataset.symbol;
            const count = input.dataset.count;
            if (!newPaytable[symbol]) {
                newPaytable[symbol] = {};
            }
            newPaytable[symbol][count] = parseInt(input.value, 10);
        });

        try {
            // This is the special part for the sandboxed environment.
            // The server will respond with the content of the new config file.
            const data = await apiRequest('/api/admin/settings', 'PUT', { paytable: newPaytable });

            // In a real app, we would not need the next step. But here, we must
            // signal that the file needs to be overwritten by the agent.
            adminMessage.textContent = `Payouts saved successfully! The server config needs to be updated by the system. Content to use is in the API response.`;
            adminMessage.style.color = 'green';

            // For now, we can just reload the paytable to show it's updated in memory for this session
            // NOTE: This won't work in the current setup because the config is not really mutable.
            // A page refresh would lose the changes. This is a limitation of the environment.

        } catch (err) {
            adminMessage.textContent = `Error saving paytable: ${err.message}`;
            adminMessage.style.color = 'red';
        }
    });

    // --- USER MANAGEMENT ---
    document.getElementById('create-user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('create-username').value;
        const initialBalance = parseInt(document.getElementById('create-balance').value, 10);
        try {
            const newUser = await apiRequest('/api/admin/users/create', 'POST', { username, initialBalance });
            adminMessage.textContent = `User ${newUser.username} (ID: ${newUser.id}) created successfully.`;
            adminMessage.style.color = 'green';
            e.target.reset();
        } catch (err) {
            adminMessage.textContent = `Error creating user: ${err.message}`;
            adminMessage.style.color = 'red';
        }
    });

    document.getElementById('update-balance-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const userId = document.getElementById('update-userid').value;
        const newBalance = parseInt(document.getElementById('update-balance').value, 10);
        try {
            const updatedUser = await apiRequest(`/api/admin/users/${userId}/balance`, 'PUT', { newBalance });
            adminMessage.textContent = `User ${updatedUser.username}'s balance updated to ${updatedUser.balance}.`;
            adminMessage.style.color = 'green';
            e.target.reset();
        } catch (err) {
            adminMessage.textContent = `Error updating balance: ${err.message}`;
            adminMessage.style.color = 'red';
        }
    });

</script>

</body>
</html>
