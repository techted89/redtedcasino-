<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f4; color: #333; }
        .container { max-width: 800px; margin: auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 20px;}
        .hidden { display: none; }
        h1, h2, h3 { color: #555; }
        input, button, select { padding: 8px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd; }
        button { background-color: #007bff; color: white; cursor: pointer; }
        button:hover { background-color: #0056b3; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 8px; text-align: left; }
        th { background-color: #f2f2f2; cursor: pointer; }
        th:hover { background-color: #e8e8e8; }
    </style>
</head>
<body>

<div id="login-section" class="container">
    <h1>Admin Login</h1>
    <form id="login-form">
        <input type="password" id="admin-password" placeholder="Enter Admin Password" required>
        <button type="submit">Login</button>
    </form>
    <p id="login-error" style="color: red;"></p>
</div>

<div id="admin-panel" class="container hidden">
    <h1>Admin Panel</h1>
    <p id="admin-message" style="color: green;"></p>

    <!-- User Management Section -->
    <section id="user-management">
        <!-- ... user management HTML is unchanged ... -->
    </section>

    <hr>

    <!-- Game Management Section -->
    <section id="game-management">
        <h2>Game Management</h2>
        <p>Select a game to edit its paytable. Adding new games must be done in the server's config file for now.</p>
        <select id="game-select"></select>

        <form id="paytable-form" class="hidden">
            <h3 id="paytable-header"></h3>
            <div id="paytable-container"></div>
            <button type="submit">Save Paytable</button>
        </form>
    </section>
</div>

<script>
    // --- OMITTING UNCHANGED JS FOR BREVITY ---
    // (login, apiHelper, user management functions are the same)

    let allGames = [];
    const gameSelect = document.getElementById('game-select');
    const paytableForm = document.getElementById('paytable-form');
    const paytableHeader = document.getElementById('paytable-header');
    const paytableContainer = document.getElementById('paytable-container');

    // --- NEW & MODIFIED JS ---
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        // ... (login logic) ...
        // On success:
        // adminToken = data.token;
        // loginSection.classList.add('hidden');
        // adminPanel.classList.remove('hidden');
        await loadUsers();
        await loadGames(); // New call
    });

    async function loadGames() {
        try {
            allGames = await apiRequest('/api/admin/games');
            gameSelect.innerHTML = '<option value="">-- Select a Game to Edit --</option>';
            allGames.forEach(game => {
                const option = document.createElement('option');
                option.value = game.id;
                option.textContent = game.name;
                gameSelect.appendChild(option);
            });
        } catch (err) {
            setMessage(`Error loading games: ${err.message}`, true);
        }
    }

    gameSelect.addEventListener('change', () => {
        const gameId = gameSelect.value;
        if (gameId) {
            const game = allGames.find(g => g.id === gameId);
            renderPaytable(game);
            paytableForm.classList.remove('hidden');
        } else {
            paytableForm.classList.add('hidden');
        }
    });

    function renderPaytable(game) {
        paytableHeader.textContent = `Editing Paytable for: ${game.name}`;
        let tableHTML = '<table><thead><tr><th>Symbol</th><th>3 in a row</th><th>4 in a row</th><th>5 in a row</th></tr></thead><tbody>';
        for (const symbolKey in game.symbols) {
            // Ensure we only show actual symbols, not other properties
            if (Object.prototype.hasOwnProperty.call(game.symbols, symbolKey)) {
                 const payouts = game.paytable[symbolKey] || {};
                 tableHTML += `<tr>
                    <td>${symbolKey}</td>
                    <td><input type="number" data-symbol="${symbolKey}" data-count="3" value="${payouts['3'] || 0}"></td>
                    <td><input type="number" data-symbol="${symbolKey}" data-count="4" value="${payouts['4'] || 0}"></td>
                    <td><input type="number" data-symbol="${symbolKey}" data-count="5" value="${payouts['5'] || 0}"></td>
                </tr>`;
            }
        }
        tableHTML += '</tbody></table>';
        paytableContainer.innerHTML = tableHTML;
    }

    paytableForm.addEventListener('submit', async (e) => {
        e.preventDefault();
        const gameId = gameSelect.value;
        if (!gameId) return;

        const newPaytable = {};
        const inputs = document.querySelectorAll('#paytable-container input');
        inputs.forEach(input => {
            const symbol = input.dataset.symbol;
            const count = input.dataset.count;
            if (!newPaytable[symbol]) newPaytable[symbol] = {};
            newPaytable[symbol][count] = parseInt(input.value, 10);
        });

        try {
            await apiRequest(`/api/admin/games/${gameId}`, 'PUT', { paytable: newPaytable });
            setMessage(`Paytable for ${gameId} saved successfully (in memory).`, false);
            // Refresh game data to reflect in-memory change
            await loadGames();
            gameSelect.value = gameId; // Keep the current game selected
            const game = allGames.find(g => g.id === gameId);
            renderPaytable(game);

        } catch (err) {
            setMessage(`Error saving paytable: ${err.message}`, true);
        }
    });


    // --- PASTE FULL SCRIPT FOR COMPLETENESS ---
    const loginSection = document.getElementById('login-section');
    const adminPanel = document.getElementById('admin-panel');
    const loginError = document.getElementById('login-error');
    const adminMessage = document.getElementById('admin-message');

    let adminToken = null;
    let allUsers = [];
    let sortState = { key: 'id', asc: true };

    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        loginError.textContent = '';
        const password = document.getElementById('admin-password').value;

        try {
            const response = await fetch('/api/admin/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ password })
            });
            const data = await response.json();
            if (response.ok) {
                adminToken = data.token;
                loginSection.classList.add('hidden');
                adminPanel.classList.remove('hidden');
                await loadUsers();
                await loadGames();
            } else {
                throw new Error(data.message || 'Login failed');
            }
        } catch (err) {
            loginError.textContent = err.message;
        }
    });

    async function apiRequest(endpoint, method = 'GET', body = null) {
        const options = {
            method,
            headers: { 'Content-Type': 'application/json', 'x-admin-token': adminToken }
        };
        if (body) options.body = JSON.stringify(body);
        const response = await fetch(endpoint, options);
        if (!response.ok) {
            const errorData = await response.json();
            throw new Error(errorData.message || `API request to ${endpoint} failed`);
        }
        return response.json();
    }

    async function loadUsers() {
        try {
            allUsers = await apiRequest('/api/admin/users');
            renderUserTable(allUsers);
        } catch (err) {
            setMessage(`Error loading users: ${err.message}`, true);
        }
    }

    function renderUserTable(users) {
        const tbody = document.getElementById('user-table-body');
        tbody.innerHTML = '';
        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.balance}</td>
                <td>
                    <input type="number" step="any" placeholder="New Balance" id="balance-input-${user.id}">
                    <button data-userid="${user.id}">Update</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    document.getElementById('user-table').addEventListener('click', (e) => {
        if (e.target.tagName === 'BUTTON' && e.target.dataset.userid) {
            const userId = e.target.dataset.userid;
            const newBalanceInput = document.getElementById(`balance-input-${userId}`);
            const newBalance = parseFloat(newBalanceInput.value);
            if (!isNaN(newBalance)) {
                updateUserBalance(userId, newBalance);
            } else {
                setMessage('Please enter a valid number for the balance.', true);
            }
        }
        if (e.target.tagName === 'TH' && e.target.dataset.sort) {
            const sortKey = e.target.dataset.sort;
            sortState.asc = sortState.key === sortKey ? !sortState.asc : true;
            sortState.key = sortKey;
            sortUsers(sortKey, sortState.asc);
        }
    });

    function sortUsers(key, asc = true) {
        const sortedUsers = [...allUsers].sort((a, b) => {
            if (a[key] < b[key]) return asc ? -1 : 1;
            if (a[key] > b[key]) return asc ? 1 : -1;
            return 0;
        });
        renderUserTable(sortedUsers);
    }

    document.getElementById('user-search').addEventListener('input', (e) => {
        const searchTerm = e.target.value.toLowerCase();
        const filteredUsers = allUsers.filter(user =>
            user.username.toLowerCase().includes(searchTerm) ||
            user.id.toLowerCase().includes(searchTerm)
        );
        renderUserTable(filteredUsers);
    });

    async function updateUserBalance(userId, newBalance) {
        try {
            const updatedUser = await apiRequest(`/api/admin/users/${userId}/balance`, 'PUT', { newBalance });
            setMessage(`User ${updatedUser.username}'s balance updated to ${updatedUser.balance}.`, false);
            await loadUsers();
        } catch (err) {
            setMessage(`Error updating balance: ${err.message}`, true);
        }
    }

    document.getElementById('create-user-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('create-username').value;
        const initialBalance = parseFloat(document.getElementById('create-balance').value);
        try {
            const newUser = await apiRequest('/api/admin/users/create', 'POST', { username, initialBalance });
            setMessage(`User ${newUser.username} created successfully.`, false);
            e.target.reset();
            await loadUsers();
        } catch (err) {
            setMessage(`Error creating user: ${err.message}`, true);
        }
    });

    function setMessage(msg, isError = false) {
        adminMessage.textContent = msg;
        adminMessage.style.color = isError ? 'red' : 'green';
    }
</script>

</body>
</html>
