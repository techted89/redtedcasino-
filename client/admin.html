<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
    <style>
        body { font-family: sans-serif; background-color: #f4f4f4; color: #333; margin: 0; padding: 20px; }
        .container { max-width: 1200px; margin: auto; padding: 20px; background-color: #fff; border-radius: 8px; box-shadow: 0 0 10px rgba(0,0,0,0.1); margin-bottom: 20px;}
        .hidden { display: none; }
        h1, h2, h3 { color: #555; }
        input, button, select { padding: 10px; margin: 5px 0; border-radius: 4px; border: 1px solid #ddd; width: calc(100% - 22px); }
        button { background-color: #007bff; color: white; cursor: pointer; border: none; width: auto; padding: 10px 15px; }
        button:hover { background-color: #0056b3; }
        button.approve-btn { background-color: #28a745; }
        button.reject-btn { background-color: #dc3545; }
        table { width: 100%; border-collapse: collapse; margin-top: 15px; }
        th, td { border: 1px solid #ddd; padding: 12px; text-align: left; }
        th { background-color: #f2f2f2; cursor: pointer; }
        th:hover { background-color: #e8e8e8; }
        form { display: flex; flex-direction: column; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; }
        .action-cell input { width: 100px; margin-right: 5px; }
        .action-cell button { width: auto; }
        hr { margin: 30px 0; }
    </style>
</head>
<body>

<div id="login-section" class="container">
    <h1>Admin Login</h1>
    <form id="login-form">
        <input type="text" id="admin-username" placeholder="Username" required>
        <input type="password" id="admin-password" placeholder="Password" required>
        <button type="submit">Login</button>
    </form>
    <p id="login-error" style="color: red;"></p>
</div>

<div id="admin-panel" class="container hidden">
    <h1>Admin Panel <button id="logout-button" style="float: right; background-color: #dc3545;">Logout</button></h1>
    <p id="admin-message" style="color: green;"></p>

    <!-- User Management -->
    <section id="user-management">
        <h2>User Management</h2>
        <input type="text" id="user-search" placeholder="Search by username or ID...">
        <h3>Create New User</h3>
        <form id="create-user-form">
            <div class="form-grid">
                <input type="text" id="create-username" placeholder="Username" required>
                <input type="password" id="create-password" placeholder="Initial Password" required>
                <input type="text" id="create-firstname" placeholder="First Name" required>
                <input type="text" id="create-lastname" placeholder="Last Name" required>
                <input type="number" id="create-age" placeholder="Age" required>
                <input type="number" id="create-balance" placeholder="Initial Balance" step="any" required>
            </div>
            <button type="submit">Create User</button>
        </form>
        <table id="user-table">
            <thead>
                <tr>
                    <th data-sort="id">ID</th>
                    <th data-sort="username">Username</th>
                    <th data-sort="accountId">Account ID</th>
                    <th data-sort="balance">Balance</th>
                    <th>Set Balance</th>
                </tr>
            </thead>
            <tbody id="user-table-body"></tbody>
        </table>
    </section>

    <hr>

    <!-- Withdrawal Requests -->
    <section id="withdrawal-management">
        <h2>Withdrawal Requests</h2>
        <table id="withdrawal-table">
            <thead>
                <tr>
                    <th>Req. ID</th>
                    <th>Username</th>
                    <th>Amount</th>
                    <th>Date</th>
                    <th>Status</th>
                    <th>Actions</th>
                </tr>
            </thead>
            <tbody id="withdrawal-table-body"></tbody>
        </table>
    </section>

    <hr>

    <!-- Game Management -->
    <section id="game-management">
        <h2>Game Management</h2>
        <select id="game-select" style="width: 100%;"></select>
        <form id="paytable-form" class="hidden">
            <h3 id="paytable-header"></h3>
            <div id="paytable-container"></div>
            <button type="submit">Save Paytable</button>
        </form>
    </section>
</div>

<script>
    // --- Global Variables & Elements ---
    const loginSection = document.getElementById('login-section');
    const adminPanel = document.getElementById('admin-panel');
    const adminMessage = document.getElementById('admin-message');
    let allUsers = [];
    let allGames = [];
    let allWithdrawals = [];
    let sortState = { key: 'id', asc: true };

    // --- Core Auth & API ---
    async function apiRequest(endpoint, method = 'GET', body = null) {
        const token = sessionStorage.getItem('adminToken');
        if (!token) { handleLogout(); throw new Error('No token found.'); }
        const options = { method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` } };
        if (body) options.body = JSON.stringify(body);
        const response = await fetch(endpoint, options);
        if (response.status === 401 || response.status === 403) { handleLogout(); throw new Error('Session expired.'); }
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || 'API Request Failed');
        return data;
    }

    function handleLogout() {
        sessionStorage.removeItem('adminToken');
        loginSection.classList.remove('hidden');
        adminPanel.classList.add('hidden');
    }

    // --- Initial Load ---
    async function loadInitialData() {
        setMessage('Loading data...', false);
        try {
            await Promise.all([loadUsers(), loadGames(), loadWithdrawalRequests()]);
            setMessage('Data loaded successfully.', false);
        } catch(err) {
            setMessage(err.message, true);
        }
    }

    window.addEventListener('load', () => {
        if (sessionStorage.getItem('adminToken')) {
            loginSection.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            loadInitialData();
        }
    });

    // --- User Management ---
    async function loadUsers() {
        allUsers = await apiRequest('/api/admin/users');
        renderUserTable(allUsers);
    }

    function renderUserTable(users) {
        const tbody = document.getElementById('user-table-body');
        tbody.innerHTML = '';
        users.forEach(user => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${user.id}</td>
                <td>${user.username}</td>
                <td>${user.accountId}</td>
                <td>${user.balance.toFixed(2)}</td>
                <td class="action-cell">
                    <input type="number" step="any" placeholder="New Balance" id="balance-input-${user.id}">
                    <button data-userid="${user.id}" data-action="set-balance">Set</button>
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    async function handleUserTableClick(e) {
        if (e.target.tagName === 'BUTTON' && e.target.dataset.action === 'set-balance') {
            const userId = e.target.dataset.userid;
            const input = document.getElementById(`balance-input-${userId}`);
            const newBalance = parseFloat(input.value);
            if (isNaN(newBalance) || newBalance < 0) {
                setMessage('Please enter a valid, non-negative balance.', true);
                return;
            }
            try {
                await apiRequest(`/api/admin/users/${userId}/balance`, 'PUT', { newBalance });
                setMessage(`User ${userId}'s balance updated.`, false);
                await loadUsers(); // Refresh
            } catch (err) {
                setMessage(err.message, true);
            }
        }
        if (e.target.tagName === 'TH' && e.target.dataset.sort) {
            const sortKey = e.target.dataset.sort;
            sortState.asc = sortState.key === sortKey ? !sortState.asc : true;
            sortState.key = sortKey;
            const sortedUsers = [...allUsers].sort((a, b) => (a[sortKey] < b[sortKey]) ? (sortState.asc ? -1 : 1) : (sortState.asc ? 1 : -1));
            renderUserTable(sortedUsers);
        }
    }

    // --- Withdrawal Management ---
    async function loadWithdrawalRequests() {
        allWithdrawals = await apiRequest('/api/admin/withdrawal-requests');
        renderWithdrawalRequestsTable(allWithdrawals);
    }

    function renderWithdrawalRequestsTable(requests) {
        const tbody = document.getElementById('withdrawal-table-body');
        tbody.innerHTML = '';
        requests.forEach(req => {
            const row = document.createElement('tr');
            row.innerHTML = `
                <td>${req.id}</td>
                <td>${req.username}</td>
                <td>${req.amount.toFixed(2)}</td>
                <td>${new Date(req.requestedAt).toLocaleString()}</td>
                <td>${req.status}</td>
                <td class="action-cell">
                    ${req.status === 'pending' ? `
                        <button class="approve-btn" data-reqid="${req.id}" data-action="approve">Approve</button>
                        <button class="reject-btn" data-reqid="${req.id}" data-action="reject">Reject</button>
                    ` : `Reviewed by admin ${req.reviewerId || ''} on ${new Date(req.reviewedAt).toLocaleDateString()}`}
                </td>
            `;
            tbody.appendChild(row);
        });
    }

    async function handleWithdrawalTableClick(e) {
        const action = e.target.dataset.action;
        if (!action) return;
        const requestId = e.target.dataset.reqid;
        try {
            await apiRequest(`/api/admin/withdrawal-requests/${requestId}`, 'PUT', { status: action });
            setMessage(`Request ${requestId} has been ${action}.`, false);
            await Promise.all([loadWithdrawalRequests(), loadUsers()]); // Refresh both tables
        } catch (err) {
            setMessage(err.message, true);
        }
    }

    // --- Event Listeners ---
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('admin-username').value;
        const password = document.getElementById('admin-password').value;
        try {
            const data = await fetch('/api/admin/login', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            }).then(res => res.ok ? res.json() : Promise.reject(res.json()));
            sessionStorage.setItem('adminToken', data.token);
            loginSection.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            await loadInitialData();
        } catch (errPromise) {
            errPromise.then(err => setMessage(err.message, true));
        }
    });

    document.getElementById('logout-button').addEventListener('click', handleLogout);
    document.getElementById('user-table').addEventListener('click', handleUserTableClick);
    document.getElementById('withdrawal-table').addEventListener('click', handleWithdrawalTableClick);
    // Other event listeners (create user, search, game management) are omitted for brevity but would be here.

    // --- Utility ---
    function setMessage(msg, isError = false) {
        adminMessage.textContent = msg;
        adminMessage.style.color = isError ? 'red' : 'green';
        setTimeout(() => adminMessage.textContent = '', 5000);
    }

    // Dummy listeners for brevity, to avoid null errors on the functions that were omitted
    document.getElementById('create-user-form').addEventListener('submit', e => e.preventDefault());
    document.getElementById('user-search').addEventListener('input', e => e.preventDefault());
    document.getElementById('game-select').addEventListener('change', e => e.preventDefault());
    document.getElementById('paytable-form').addEventListener('submit', e => e.preventDefault());

</script>

</body>
</html>
