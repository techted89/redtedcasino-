<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Page</title>
    <style>/* ... styles omitted for brevity ... */</style>
</head>
<body>
<div id="login-section" class="container">...</div>
<div id="admin-panel" class="container hidden">
    <!-- ... all HTML sections ... -->
</div>

<script>
    const API_BASE_URL = 'http://74.208.167.101';

    // --- Global Variables & Elements ---
    const loginSection = document.getElementById('login-section');
    const adminPanel = document.getElementById('admin-panel');
    const adminMessage = document.getElementById('admin-message');
    const gameSelect = document.getElementById('game-select');
    let allGames = {}; // Holds basic game info (name, symbols)
    let allUsers = [];
    let allWithdrawals = [];
    let allStats = [];
    let sortState = { key: 'id', asc: true };

    // --- Core Auth & API ---
    async function apiRequest(endpoint, method = 'GET', body = null) {
        const token = sessionStorage.getItem('adminToken');
        if (!token) { handleLogout(); throw new Error('No token found.'); }
        const options = { method, headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${token}` } };
        if (body) options.body = JSON.stringify(body);
        const response = await fetch(`${API_BASE_URL}${endpoint}`, options); // Use base URL
        if (response.status === 401 || response.status === 403) { handleLogout(); throw new Error('Session expired.'); }
        const data = await response.json();
        if (!response.ok) throw new Error(data.message || 'API Request Failed');
        return data;
    }
    function handleLogout() { /* ... */ }

    // --- Initial Load ---
    async function loadInitialData() {
        setMessage('Loading data...', false);
        try {
            await Promise.all([
                loadUsers(),
                loadWithdrawalRequests(),
                loadGames(),
                loadStatistics()
            ]);
            setMessage('Data loaded successfully.', false);
        } catch(err) {
            setMessage(err.message, true);
        }
    }
    window.addEventListener('load', () => {
        if (sessionStorage.getItem('adminToken')) {
            loginSection.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            loadInitialData();
        }
    });

    // --- Login ---
    document.getElementById('login-form').addEventListener('submit', async (e) => {
        e.preventDefault();
        const username = document.getElementById('admin-username').value;
        const password = document.getElementById('admin-password').value;
        try {
            const response = await fetch(`${API_BASE_URL}/api/admin/login`, { // Use base URL
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ username, password })
            });
            const data = await response.json();
            if (!response.ok) throw new Error(data.message);
            sessionStorage.setItem('adminToken', data.token);
            loginSection.classList.add('hidden');
            adminPanel.classList.remove('hidden');
            await loadInitialData();
        } catch (err) {
            setMessage(err.message, true);
        }
    });

    // All other functions (loadUsers, renderUserTable, loadGames, etc.)
    // will now use the updated apiRequest function, so they don't need to be changed individually.
    // The full script from the last correct version would be here.
    // This is just a summary of the key change.
</script>
</body>
</html>
